"use client";import { useState } from "react";import * as XLSX from "xlsx";import {  Box,  Typography,  CircularProgress,  Divider,  Alert,  AlertTitle,  Stack,} from "@mui/material";import {  Download as DownloadIcon,  Description as DescriptionIcon,  Backup as BackupIcon,  CloudUpload as CloudUploadIcon,} from "@mui/icons-material";import { productsApi } from "@/app/lib/api/products";
import { backupApi } from "@/app/lib/api/backup";
import { Product, Rubro } from "@/app/lib/types/types";
import ProtectedRoute from "@/app/components/ProtectedRoute";import ImportFileButton from "@/app/components/ImportFileButton";import Notification from "@/app/components/Notification";import Button from "@/app/components/Button";import { useNotification } from "@/app/hooks/useNotification";export default function ImportExportPage() {  const [excelLoading, setExcelLoading] = useState(false);  const [jsonLoading, setJsonLoading] = useState(false);
  const {
    isNotificationOpen,    notificationMessage,    notificationType,    showNotification,    closeNotification,  } = useNotification();  const importExcelData = async (    event: React.ChangeEvent<HTMLInputElement>  ) => {    const file = event.target.files?.[0];    if (!file) return;    setExcelLoading(true);    try {      const data = await readExcelFile(file);      const processed = await processExcelProducts(data);      showNotification(        `Productos importados exitosamente: ${processed.length} procesados`,        "success"      );    } catch (error) {      console.error("Error al importar Excel:", error);      showNotification(        `Error al importar Excel: ${          error instanceof Error ? error.message : "Error desconocido"        }`,        "error"      );    } finally {      setExcelLoading(false);      event.target.value = "";    }  };  const readExcelFile = (file: File): Promise<Record<string, unknown>[]> => {    return new Promise((resolve, reject) => {      const reader = new FileReader();      reader.onload = (e) => {        try {          const data = e.target?.result;          const workbook = XLSX.read(data, { type: "array" });          const firstSheetName = workbook.SheetNames[0];          const worksheet = workbook.Sheets[firstSheetName];          const jsonData = XLSX.utils.sheet_to_json<Record<string, unknown>>(            worksheet,            {              raw: false,              defval: "",            }          );          resolve(jsonData);        } catch (error) {          reject(error);        }      };      reader.onerror = () => {        reject(new Error("Error al leer el archivo Excel"));      };      reader.readAsArrayBuffer(file);    });  };  const processExcelProducts = async (excelData: Record<string, unknown>[]) => {    const processedProducts: Product[] = [];    const errors: string[] = [];    let existingProducts = await productsApi.getAll();    for (let i = 0; i < excelData.length; i++) {      const row = excelData[i];      const rowNumber = i + 2;       try {        const productData: Partial<Product> = {          name:            (row["Nombre"] as string)?.trim() ||            (row["name"] as string)?.trim(),          barcode:            (row["Código de Barras"] as string)?.trim() ||            (row["Barcode"] as string)?.trim() ||            (row["barcode"] as string)?.trim(),          stock: parseFloat(            (row["Stock"] as string) ||              (row["stock"] as string) ||              (row["Cantidad"] as string) ||              "0"          ),          costPrice: parseFloat(            (row["Precio Costo"] as string) ||              (row["Costo"] as string) ||              (row["costPrice"] as string) ||              "0"          ),          price: parseFloat(            (row["Precio Venta"] as string) ||              (row["Precio"] as string) ||              (row["price"] as string) ||              "0"          ),          unit: ((row["Unidad"] as string) ||            (row["unit"] as string) ||            "Unid.") as Product["unit"],          category:            (row["Categoría"] as string)?.trim() ||            (row["category"] as string)?.trim(),          brand:            (row["Marca"] as string)?.trim() ||            (row["brand"] as string)?.trim(),          color:            (row["Color"] as string)?.trim() ||            (row["color"] as string)?.trim(),          size:            (row["Talle"] as string)?.trim() || (row["size"] as string)?.trim(),          rubro: ((row["Rubro"] as string) ||            (row["rubro"] as string) ||            "comercio") as Rubro,          description:            (row["Descripción"] as string)?.trim() ||            (row["description"] as string)?.trim(),          location:            (row["Ubicación"] as string)?.trim() ||            (row["location"] as string)?.trim(),          lot:            (row["Lote"] as string)?.trim() || (row["lot"] as string)?.trim(),          season:            (row["Temporada"] as string)?.trim() ||            (row["season"] as string)?.trim(),          hasIvaIncluded:            (row["IVA Incluido"] as string)?.toLowerCase() === "si" ||            (row["IVA"] as string)?.toLowerCase() === "si" ||            (row["hasIvaIncluded"] as string)?.toLowerCase() === "true" ||            true,          minStock: parseFloat(            (row["Stock Mínimo"] as string) ||              (row["minStock"] as string) ||              "0"          ),          setMinStock: !!(row["Stock Mínimo"] || row["minStock"]),        };        if (!productData.name) {          throw new Error(`Fila ${rowNumber}: Nombre es requerido`);        }        if (isNaN(productData.stock!)) {          throw new Error(`Fila ${rowNumber}: Stock inválido`);        }        if (isNaN(productData.costPrice!)) {          throw new Error(`Fila ${rowNumber}: Precio de costo inválido`);
        }        if (isNaN(productData.price!)) {          throw new Error(`Fila ${rowNumber}: Precio de venta inválido`);
        }        if (row["Vencimiento"] || row["Expiration"]) {          const expiration = row["Vencimiento"] || row["Expiration"];          if (expiration) {            const date = parseExcelDate(expiration);            if (date) {              productData.expiration = date.toISOString().split("T")[0];
            }          }        }        let existingProduct: Product | undefined;        if (productData.barcode) {          existingProduct = existingProducts.find(p => p.barcode === productData.barcode);
        }        if (!existingProduct && productData.name) {          existingProduct = existingProducts.find(p => p.name === productData.name);
        }        const now = new Date().toISOString();        const baseProduct = {          name: productData.name,          barcode: productData.barcode || "",          stock: productData.stock || 0,          costPrice: productData.costPrice || 0,          price: productData.price || 0,          currentPrice: productData.price || 0,          quantity: productData.stock || 0,          unit: productData.unit || "Unid.",          rubro: productData.rubro || "comercio",          hasIvaIncluded:            productData.hasIvaIncluded !== undefined              ? productData.hasIvaIncluded              : true,          expiration: productData.expiration || "",          category: productData.category || "",          brand: productData.brand || "",          color: productData.color || "",          size: productData.size || "",          description: productData.description || "",          location: productData.location || "",          lot: productData.lot || "",          season: productData.season || "",          customCategory: productData.category || "",          customCategories: productData.category            ? [                {                  name: productData.category,                  rubro: productData.rubro || "comercio",
                },              ]            : [],          setMinStock: productData.setMinStock || false,          minStock: productData.minStock || 0,          updatedAt: now,        };        if (existingProduct) {          const updated = await productsApi.update(existingProduct.id, {            ...baseProduct,            createdAt: existingProduct.createdAt,           });          existingProducts = existingProducts.map(p => p.id === updated.id ? updated : p);
          processedProducts.push(updated);          console.log(`Producto actualizado: ${updated.name}`);
        } else {          if (!baseProduct.barcode) {            baseProduct.barcode = generateAutoBarcode();
          }          const created = await productsApi.create({              ...baseProduct,              createdAt: now,          });          existingProducts.push(created);          processedProducts.push(created);          console.log(`Producto agregado: ${created.name}`);
        }      } catch (error) {        errors.push(          `Fila ${rowNumber}: ${            error instanceof Error ? error.message : "Error desconocido"          }`        );      }    }    if (errors.length > 0) {      throw new Error(`Errores encontrados:\n${errors.join("\n")}`);
    }    return processedProducts;  };  const parseExcelDate = (excelDate: unknown): Date | null => {    try {      if (excelDate instanceof Date) {        return excelDate;      }      if (typeof excelDate === "number") {        const excelEpoch = new Date(1899, 11, 30);        return new Date(excelEpoch.getTime() + excelDate * 24 * 60 * 60 * 1000);
      }      if (typeof excelDate === "string") {        const date = new Date(excelDate);        if (!isNaN(date.getTime())) {          return date;        }      }      return null;    } catch {      return null;    }  };  const generateAutoBarcode = (): string => {    let baseCode = "";    for (let i = 0; i < 12; i++) {      baseCode += Math.floor(Math.random() * 10).toString();
    }    let sum = 0;    for (let i = 0; i < 12; i++) {      const digit = parseInt(baseCode[i]);      sum += i % 2 === 0 ? digit : digit * 3;
    }    const remainder = sum % 10;    const checkDigit = remainder === 0 ? 0 : 10 - remainder;    return baseCode + checkDigit.toString();  };  const downloadExcelTemplate = () => {    const templateData = [      {        Nombre: "Producto Básico",        "Código de Barras": "1234567890123",        Stock: "100",        "Precio Costo": "50",        "Precio Venta": "75",        Unidad: "Unid.",        Categoría: "General",        Marca: "Marca Genérica",        Color: "",        Talle: "",        Rubro: "comercio",        Descripción: "Producto de ejemplo unidad básica",        Ubicación: "Estante A1",        Lote: "LOT001",        Temporada: "todo el año",        "IVA Incluido": "Si",        "Stock Mínimo": "10",        Vencimiento: "2024-12-31",      },      {        Nombre: "Arroz Integral",        "Código de Barras": "7891234560123",        Stock: "50",        "Precio Costo": "30",        "Precio Venta": "45",        Unidad: "Kg",        Categoría: "Alimentos",        Marca: "Marca Arroz",        Color: "",        Talle: "",        Rubro: "comercio",        Descripción: "Arroz integral en kilogramos",        Ubicación: "Estante B2",        Lote: "LOT002",        Temporada: "todo el año",        "IVA Incluido": "Si",        "Stock Mínimo": "5",        Vencimiento: "2024-10-15",      },      {        Nombre: "Leche Descremada",        "Código de Barras": "4567891230456",        Stock: "200",        "Precio Costo": "25",        "Precio Venta": "40",        Unidad: "L",        Categoría: "Lácteos",        Marca: "Marca Lechera",        Color: "",        Talle: "",        Rubro: "comercio",        Descripción: "Leche descremada en litros",        Ubicación: "Estante C3",        Lote: "LOT003",        Temporada: "todo el año",        "IVA Incluido": "Si",        "Stock Mínimo": "20",        Vencimiento: "2024-08-30",      },      {        Nombre: "Cable Eléctrico",        "Código de Barras": "3216549870321",        Stock: "500",        "Precio Costo": "15",        "Precio Venta": "25",        Unidad: "M",        Categoría: "Electricidad",        Marca: "Marca Cable",        Color: "Negro",        Talle: "",        Rubro: "comercio",        Descripción: "Cable eléctrico por metro",        Ubicación: "Estante D4",        Lote: "LOT004",        Temporada: "todo el año",        "IVA Incluido": "Si",        "Stock Mínimo": "50",        Vencimiento: "",      },      {        Nombre: "Azúcar",        "Código de Barras": "9876543210987",        Stock: "1000",        "Precio Costo": "5",        "Precio Venta": "8",        Unidad: "Gr",        Categoría: "Alimentos",        Marca: "Marca Azúcar",        Color: "",        Talle: "",        Rubro: "comercio",        Descripción: "Azúcar en gramos",        Ubicación: "Estante E5",        Lote: "LOT005",        Temporada: "todo el año",        "IVA Incluido": "Si",        "Stock Mínimo": "100",        Vencimiento: "2025-06-30",      },      {        Nombre: "Perfume",        "Código de Barras": "1472583690147",        Stock: "300",        "Precio Costo": "80",        "Precio Venta": "120",        Unidad: "Ml",        Categoría: "Perfumería",        Marca: "Marca Perfumes",        Color: "",        Talle: "",        Rubro: "comercio",        Descripción: "Perfume en mililitros",        Ubicación: "Estante F6",        Lote: "LOT006",        Temporada: "todo el año",        "IVA Incluido": "Si",        "Stock Mínimo": "30",        Vencimiento: "2025-03-15",      },      {        Nombre: "Cemento",        "Código de Barras": "2583691470258",        Stock: "2000",        "Precio Costo": "120",        "Precio Venta": "180",        Unidad: "Kg",        Categoría: "Construcción",        Marca: "Marca Cemento",        Color: "Gris",        Talle: "",        Rubro: "comercio",        Descripción: "Cemento por kilogramo",        Ubicación: "Bodega Exterior",        Lote: "LOT007",        Temporada: "todo el año",        "IVA Incluido": "Si",        "Stock Mínimo": "200",        Vencimiento: "2024-11-30",      },      {        Nombre: "Pintura Blanca",        "Código de Barras": "3692581470369",        Stock: "150",        "Precio Costo": "200",        "Precio Venta": "300",        Unidad: "L",        Categoría: "Pinturas",        Marca: "Marca Pintura",        Color: "Blanco",        Talle: "",        Rubro: "comercio",        Descripción: "Pintura blanca en litros",        Ubicación: "Estante G7",        Lote: "LOT008",        Temporada: "todo el año",        "IVA Incluido": "Si",        "Stock Mínimo": "15",        Vencimiento: "2025-01-31",      },      {        Nombre: "Madera",        "Código de Barras": "6549873210654",        Stock: "800",        "Precio Costo": "45",        "Precio Venta": "70",        Unidad: "M",        Categoría: "Maderas",        Marca: "Marca Madera",        Color: "Natural",        Talle: "",        Rubro: "comercio",        Descripción: "Madera por metro",        Ubicación: "Bodega Madera",        Lote: "LOT009",        Temporada: "todo el año",        "IVA Incluido": "Si",        "Stock Mínimo": "80",        Vencimiento: "",      },      {        Nombre: "Cerámica",        "Código de Barras": "8527419630852",        Stock: "600",        "Precio Costo": "35",        "Precio Venta": "55",        Unidad: "M²",        Categoría: "Cerámica",        Marca: "Marca Cerámica",        Color: "Beige",        Talle: "",        Rubro: "comercio",        Descripción: "Cerámica por metro cuadrado",        Ubicación: "Estante H8",        Lote: "LOT010",        Temporada: "todo el año",        "IVA Incluido": "Si",        "Stock Mínimo": "60",        Vencimiento: "",      },      {        Nombre: "Arena",        "Código de Barras": "7418529630741",        Stock: "5000",        "Precio Costo": "15",        "Precio Venta": "25",        Unidad: "M³",        Categoría: "Construcción",        Marca: "Marca Arena",        Color: "Amarillo",        Talle: "",        Rubro: "comercio",        Descripción: "Arena por metro cúbico",        Ubicación: "Patio Exterior",        Lote: "LOT011",        Temporada: "todo el año",        "IVA Incluido": "Si",        "Stock Mínimo": "500",        Vencimiento: "",      },      {        Nombre: "TV LED 55'",        "Código de Barras": "1597534862159",        Stock: "25",        "Precio Costo": "1200",        "Precio Venta": "1800",        Unidad: "Unid.",        Categoría: "Electrónica",        Marca: "Marca TV",        Color: "Negro",        Talle: "55",        Rubro: "comercio",        Descripción: "Televisor LED 55 pulgadas",        Ubicación: "Estante I9",        Lote: "LOT012",        Temporada: "todo el año",        "IVA Incluido": "Si",        "Stock Mínimo": "3",        Vencimiento: "",      },      {        Nombre: "Clavos",        "Código de Barras": "3571597530357",        Stock: "10000",        "Precio Costo": "2",        "Precio Venta": "4",        Unidad: "Ciento",        Categoría: "Ferretería",        Marca: "Marca Clavos",        Color: "Plateado",        Talle: "2''",        Rubro: "comercio",        Descripción: "Clavos por ciento",        Ubicación: "Estante J10",        Lote: "LOT013",        Temporada: "todo el año",        "IVA Incluido": "Si",        "Stock Mínimo": "1000",        Vencimiento: "",      },      {        Nombre: "Huevos",        "Código de Barras": "4862159370486",        Stock: "500",        "Precio Costo": "40",        "Precio Venta": "60",        Unidad: "Docena",        Categoría: "Alimentos",        Marca: "Marca Huevos",        Color: "Blanco",        Talle: "",        Rubro: "comercio",        Descripción: "Huevos por docena",        Ubicación: "Refrigerador 1",        Lote: "LOT014",        Temporada: "todo el año",        "IVA Incluido": "Si",        "Stock Mínimo": "50",        Vencimiento: "2024-07-20",      },      {        Nombre: "Papel Fotográfico",        "Código de Barras": "6248371590624",        Stock: "300",        "Precio Costo": "150",        "Precio Venta": "220",        Unidad: "Cm",        Categoría: "Papelería",        Marca: "Marca Papel",        Color: "Blanco",        Talle: "",        Rubro: "comercio",        Descripción: "Papel fotográfico por centímetro",        Ubicación: "Estante K11",        Lote: "LOT015",        Temporada: "todo el año",        "IVA Incluido": "Si",        "Stock Mínimo": "30",        Vencimiento: "2025-04-30",      },      {        Nombre: "Tornillos",        "Código de Barras": "7531594862753",        Stock: "8000",        "Precio Costo": "1",        "Precio Venta": "2",        Unidad: "Mm",        Categoría: "Ferretería",        Marca: "Marca Tornillos",        Color: "Negro",        Talle: "5mm",        Rubro: "comercio",        Descripción: "Tornillos por milímetro",        Ubicación: "Estante L12",        Lote: "LOT016",        Temporada: "todo el año",        "IVA Incluido": "Si",        "Stock Mínimo": "800",        Vencimiento: "",      },      {        Nombre: "Harina",        "Código de Barras": "2947385610294",        Stock: "300",        "Precio Costo": "20",        "Precio Venta": "35",        Unidad: "Kg",        Categoría: "Alimentos",        Marca: "Marca Harina",        Color: "",        Talle: "",        Rubro: "comercio",        Descripción: "Harina de trigo",        Ubicación: "Estante M13",        Lote: "LOT017",        Temporada: "todo el año",        "IVA Incluido": "Si",        "Stock Mínimo": "30",        Vencimiento: "2024-09-15",      },      {        Nombre: "Producto Sin IVA",        "Código de Barras": "1239874560123",        Stock: "50",        "Precio Costo": "100",        "Precio Venta": "150",        Unidad: "Unid.",        Categoría: "Exento",        Marca: "Marca Exenta",        Color: "",        Talle: "",        Rubro: "comercio",        Descripción: "Producto exento de IVA",        Ubicación: "Estante N14",        Lote: "LOT018",        Temporada: "todo el año",        "IVA Incluido": "No",        "Stock Mínimo": "5",        Vencimiento: "",      },      {        Nombre: "Camisa de Algodón",        "Código de Barras": "7894561230789",        Stock: "30",        "Precio Costo": "150",        "Precio Venta": "250",        Unidad: "Unid.",        Categoría: "Ropa",        Marca: "Marca Ropa",        Color: "Azul",        Talle: "M",        Rubro: "indumentaria",        Descripción: "Camisa de algodón talle M",        Ubicación: "Perchero 1",        Lote: "LOT019",        Temporada: "verano",        "IVA Incluido": "Si",        "Stock Mínimo": "3",        Vencimiento: "",      },      {        Nombre: "Jeans",        "Código de Barras": "4561237890456",        Stock: "25",        "Precio Costo": "200",        "Precio Venta": "350",        Unidad: "Unid.",        Categoría: "Ropa",        Marca: "Marca Jeans",        Color: "Azul",        Talle: "32",        Rubro: "indumentaria",        Descripción: "Jeans talle 32",        Ubicación: "Perchero 2",        Lote: "LOT020",        Temporada: "todo el año",        "IVA Incluido": "Si",        "Stock Mínimo": "2",        Vencimiento: "",      },      {        Nombre: "Zapatillas Deportivas",        "Código de Barras": "3219876540321",        Stock: "40",        "Precio Costo": "180",        "Precio Venta": "300",        Unidad: "Unid.",        Categoría: "Calzado",        Marca: "Marca Zapatillas",        Color: "Blanco",        Talle: "42",        Rubro: "indumentaria",        Descripción: "Zapatillas deportivas talle 42",        Ubicación: "Estante Calzado",        Lote: "LOT021",        Temporada: "primavera",        "IVA Incluido": "Si",        "Stock Mínimo": "4",        Vencimiento: "",      },    ];    const worksheet = XLSX.utils.json_to_sheet(templateData);    const workbook = XLSX.utils.book_new();    XLSX.utils.book_append_sheet(workbook, worksheet, "Plantilla Productos");    const unidadesData = [      { Unidad: "Unid.", Descripción: "Unidad (productos individuales)" },      { Unidad: "Kg", Descripción: "Kilogramo (peso)" },      { Unidad: "Gr", Descripción: "Gramo (peso pequeño)" },      { Unidad: "L", Descripción: "Litro (líquidos)" },      { Unidad: "Ml", Descripción: "Mililitro (líquidos pequeños)" },      { Unidad: "M", Descripción: "Metro (longitud)" },      { Unidad: "Cm", Descripción: "Centímetro (longitud pequeña)" },      { Unidad: "Mm", Descripción: "Milímetro (longitud muy pequeña)" },      { Unidad: "M²", Descripción: "Metro cuadrado (superficie)" },      { Unidad: "M³", Descripción: "Metro cúbico (volumen)" },      {        Unidad: "Pulg",        Descripción: "Pulgada (longitud, especialmente para pantallas)",      },      { Unidad: "Docena", Descripción: "12 unidades" },      { Unidad: "Ciento", Descripción: "100 unidades" },      { Unidad: "Ton", Descripción: "Tonelada (1000 kg)" },      { Unidad: "Bulto", Descripción: "Bulto/Paquete" },      { Unidad: "Caja", Descripción: "Caja" },      { Unidad: "Cajón", Descripción: "Cajón" },      { Unidad: "General", Descripción: "Unidad general" },      { Unidad: "V", Descripción: "Voltio (electricidad)" },      { Unidad: "A", Descripción: "Amperio (electricidad)" },      { Unidad: "W", Descripción: "Watt (electricidad)" },    ];    const unidadesSheet = XLSX.utils.json_to_sheet(unidadesData);    XLSX.utils.book_append_sheet(workbook, unidadesSheet, "Guía de Unidades");    const instruccionesData = [      { Instrucción: "CÓMO USAR ESTA PLANTILLA" },      {        Instrucción:          "1. Complete los datos de sus productos en la hoja 'Plantilla Productos'",      },      {        Instrucción:          "2. Los campos obligatorios son: Nombre, Stock, Precio Costo, Precio Venta, Unidad, Rubro",      },      { Instrucción: "3. Para 'IVA Incluido' escriba 'Si' o 'No'" },      {        Instrucción: "4. Para 'Rubro' puede usar: 'comercio' o 'indumentaria'",      },      {        Instrucción:          "5. Para 'Unidad' consulte la hoja 'Guía de Unidades' para ver todas las opciones disponibles",      },      {        Instrucción:          "6. Puede borrar las filas de ejemplo y agregar sus propios productos",      },      {        Instrucción:          "7. No modifique los nombres de las columnas (primera fila)",      },      {        Instrucción:          "8. Para fechas use el formato: AAAA-MM-DD (ej: 2024-12-31)",      },      { Instrucción: "9. Guarde el archivo y luego impórtelo en el sistema" },    ];    const instruccionesSheet = XLSX.utils.json_to_sheet(instruccionesData);    XLSX.utils.book_append_sheet(workbook, instruccionesSheet, "Instrucciones");    const ajustarAnchoColumnas = <T extends Record<string, unknown>>(      sheet: XLSX.WorkSheet,      data: T[]    ) => {      if (data.length === 0) return;      const maxWidth = Object.keys(data[0]).map((key) => ({        wch: Math.max(          key.length,          ...data.map((row) => String(row[key as keyof T]).length)        ),      }));      sheet["!cols"] = maxWidth;    };    ajustarAnchoColumnas(worksheet, templateData);    ajustarAnchoColumnas(unidadesSheet, unidadesData);    ajustarAnchoColumnas(instruccionesSheet, instruccionesData);    XLSX.writeFile(workbook, "plantilla_de_prueba_universalapp.xlsx");    showNotification("Plantilla completa descargada exitosamente", "success");  };  const handleExportData = async () => {
    setJsonLoading(true);
    try {
      const data = await backupApi.export();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `backup_universal_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      showNotification("Copia de seguridad exportada exitosamente", "success");
    } catch (error) {
      console.error("Error al exportar:", error);
      showNotification("Error al exportar copia de seguridad", "error");
    } finally {
      setJsonLoading(false);
    }
  };

  const importData = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
      setJsonLoading(true);
      try {
        const content = e.target?.result as string;
        const data = JSON.parse(content) as Record<string, unknown>;

        const result = await backupApi.import(data);
        showNotification(result.message || "Datos importados correctamente", "success");
        // Opcional: recargar la página para ver cambios
        setTimeout(() => window.location.reload(), 2000);
      } catch (error) {
        console.error("Error al importar:", error);
        showNotification(
          `Error al importar: ${error instanceof Error ? error.message : "Formato inválido"}`,
          "error"
        );
      } finally {
        setJsonLoading(false);
        event.target.value = "";
      }
    };
    reader.readAsText(file);
  };
  const handleExcelImportClick = () => {    const input = document.createElement("input");    input.type = "file";    input.accept = ".xlsx,.xls,.xlsm,.xlsb,.ods";    input.onchange = (e: Event) => {      const target = e.target as HTMLInputElement;      const file = target.files?.[0];      if (!file) return;      const syntheticEvent = {        target: {          files: target.files,          value: target.value,        },      } as React.ChangeEvent<HTMLInputElement>;      importExcelData(syntheticEvent);    };    input.click();  };  return (    <ProtectedRoute>      <Box        sx={{          p: 4,          color: "text.secondary",          minHeight: "calc(100vh - 64px)",          position: "relative",        }}      >        <Typography          variant="h4"          component="h1"          sx={{            fontWeight: 700,            mb: 4,            fontSize: { xs: "1.5rem", lg: "2rem" },            color: "primary.main",            textAlign: "center",          }}        >          Gestión de Datos        </Typography>        {}        <Box sx={{ mb: 6 }}>          <Typography            variant="h5"            sx={{              fontWeight: 600,              mb: 3,              fontSize: "1.5rem",              color: "primary.main",              display: "flex",              alignItems: "center",              gap: 1,            }}          >            <BackupIcon /> Copias de Seguridad (JSON)          </Typography>          <Alert severity="info" sx={{ mb: 3 }}>            <AlertTitle>Información</AlertTitle>            Exporte o importe todos los datos del sistema en formato JSON. Esta            opción es útil para realizar copias de seguridad completas.          </Alert>          <Stack            direction={{ xs: "column", sm: "row" }}            spacing={3}            justifyContent="center"            alignItems="center"          >            <Button
              text="Exportar Copia de Seguridad"
              icon={<DownloadIcon />}
              iconPosition="left"
              onClick={handleExportData}
              disabled={jsonLoading}
              loading={jsonLoading}
              variant="contained"
              size="large"
              title="Exportar todos los datos a un archivo JSON"
              ariaLabel="Exportar datos de respaldo"
              sx={{
                minWidth: { xs: "100%", sm: "300px" },
                height: "56px",
                fontSize: "1rem",
                textTransform: "uppercase",
              }}
            />
            <ImportFileButton onImport={importData} disabled={jsonLoading} />
          </Stack>        </Box>        <Divider sx={{ my: 4 }} />        {}        <Box sx={{ mb: 4 }}>          <Typography            variant="h5"            sx={{              fontWeight: 600,              mb: 3,              fontSize: "1.5rem",              color: "success.main",              display: "flex",              alignItems: "center",              gap: 1,            }}          >            <CloudUploadIcon /> Importar Productos desde Excel (xlsx, xls)          </Typography>          <Alert severity="warning" sx={{ mb: 3 }}>            <AlertTitle>Atención</AlertTitle>            Esta función solo importa productos. Los productos existentes se            actualizarán si coinciden el código de barras o el nombre. Se            recomienda descargar la plantilla para asegurar el formato correcto.          </Alert>          <Stack            direction={{ xs: "column", sm: "row" }}            spacing={3}            justifyContent="center"            alignItems="center"          >            <Button              text="Importar Excel de productos"              icon={<DescriptionIcon />}              iconPosition="left"              onClick={handleExcelImportClick}              disabled={excelLoading}              loading={excelLoading}              variant="contained"              size="large"              title="Importar productos desde archivo Excel (.xlsx, .xls)"              ariaLabel="Importar productos desde Excel"              sx={{                textTransform: "none",                fontWeight: 600,                backgroundColor: "success.main",                color: "white",                minWidth: { xs: "100%", sm: "300px" },                height: "56px",                fontSize: "1rem",                "&:hover": {                  backgroundColor: "success.dark",                },              }}            />            <Button              text="Descargar Plantilla Excel "              title="Descargar plantilla de prueba"              variant="contained"              onClick={downloadExcelTemplate}              disabled={excelLoading}              sx={{                minWidth: { xs: "100%", sm: "300px" },                height: "56px",                fontSize: "1rem",                bgcolor: "primary.main",                "&:hover": { bgcolor: "primary.dark" },              }}            />          </Stack>        </Box>        {excelLoading && (          <Box sx={{ display: "flex", justifyContent: "center", mt: 2 }}>            <CircularProgress size={24} />            <Typography variant="body2" sx={{ ml: 1 }}>              Procesando...            </Typography>          </Box>        )}        <Notification          isOpen={isNotificationOpen}          message={notificationMessage}          type={notificationType}          onClose={closeNotification}        />      </Box>    </ProtectedRoute>  );}