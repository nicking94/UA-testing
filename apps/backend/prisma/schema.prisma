// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Rubro {
  Todos_los_rubros
  comercio
  indumentaria
}

enum PaymentMethod {
  EFECTIVO
  TRANSFERENCIA
  TARJETA
  CHEQUE
  CUENTA_CORRIENTE
  CREDITO_CUOTAS
}

enum CreditType {
  cuenta_corriente
  credito_cuotas
}

enum InstallmentStatus {
  pendiente
  pagada
  vencida
  atrasada
  cancelada
}

enum CustomerStatus {
  activo
  inactivo
}

enum BudgetStatus {
  pendiente
  aprobado
  rechazado
  cobrado
}

enum MovementType {
  INGRESO
  EGRESO
  TODOS
}

enum ExpenseType {
  INGRESO
  EGRESO
  TODOS
}

enum PromotionType {
  PERCENTAGE_DISCOUNT
  FIXED_DISCOUNT
}

enum PromotionStatus {
  active
  inactive
}

enum NotificationType {
  system
  update
  alert
  message
}

enum Unit {
  General
  A
  Bulto
  Cajon
  Caja
  Ciento
  Cm
  Docena
  Gr
  Kg
  L
  M
  M2
  M3
  Ml
  Mm
  Pulg
  Ton
  Unid
  V
  W
}

enum CheckStatus {
  pendiente
  cobrado
  rechazado
}

model User {
  id        Int      @id @default(autoincrement())
  username  String?  @unique
  password  String?
  logo      String?
  isActive  Boolean? @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  preferences UserPreferences?
  auth        Auth?
}

model Auth {
  id             Int  @id @default(autoincrement())
  isAuthenticated Boolean @default(false)
  userId         Int? @unique
  user           User? @relation(fields: [userId], references: [id])
}

model Theme {
  id    Int    @id @default(autoincrement())
  value String
}

model Product {
  id                Int      @id @default(autoincrement())
  name              String
  stock             Float    @default(0)
  costPrice         Float    @default(0)
  price             Float    @default(0)
  currentPrice      Float    @default(0)
  costPriceWithIva  Float?
  priceWithIva      Float?
  hasIvaIncluded    Boolean? @default(false)
  expiration        String?
  quantity          Float    @default(1)
  unit              Unit     @default(Unid)
  barcode           String?  @unique
  description       String?
  category          String?
  brand             String?
  color             String?
  size              String?
  rubro             Rubro    @default(comercio)
  discount          Float?   @default(0)
  surcharge         Float?   @default(0)
  basePrice         Float?
  lot               String?
  location          String?
  customCategory    String?
  season            String?
  setMinStock       Boolean? @default(false)
  minStock          Float?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  productPrices     ProductPrice[]
  saleItems         SaleItem[]
  productReturns    ProductReturn[]
  supplierProducts  SupplierProduct[]
  customCategories  ProductCustomCategory[]
}

model ProductCustomCategory {
  id        Int     @id @default(autoincrement())
  productId Int
  name      String
  rubro     Rubro
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, name, rubro])
}

model PriceList {
  id        Int      @id @default(autoincrement())
  name      String
  rubro     Rubro    @default(comercio)
  isDefault Boolean  @default(false)
  isActive  Boolean? @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productPrices ProductPrice[]
}

model ProductPrice {
  id          Int       @id @default(autoincrement())
  productId   Int
  priceListId Int
  price       Float
  costPrice   Float?
  isActive    Boolean?  @default(true)
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  priceList   PriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)

  @@unique([productId, priceListId])
  @@index([productId])
  @@index([priceListId])
}

model Customer {
  id             String    @id
  name           String
  phone          String?
  email          String?
  address        String?
  cuitDni        String?
  status         CustomerStatus @default(activo)
  pendingBalance Float     @default(0)
  rubro          Rubro?
  notes          String?
  isTemporary    Boolean?  @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  sales          Sale[]
  payments       Payment[]
  budgets        Budget[]
  customerNotes  Note[]       @relation("CustomerNotes")
}

model Supplier {
  id          Int      @id @default(autoincrement())
  companyName String
  contacts    Json? // Array of SupplierContact
  lastVisit   String?
  nextVisit   String?
  rubro       Rubro?   @default(comercio)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  supplierProducts SupplierProduct[]
}

model SupplierProduct {
  id         Int      @id @default(autoincrement())
  supplierId Int
  productId  Int
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([supplierId, productId])
}

model Sale {
  id                    Int          @id @default(autoincrement())
  total                 Float
  date                  DateTime      @default(now())
  barcode               String?
  manualAmount          Float?
  manualProfitPercentage Float?
  credit                Boolean?     @default(false)
  creditType            CreditType?
  paid                  Boolean?     @default(false)
  customerName          String?
  customerPhone         String?
  customerId            String?
  discount              Float?        @default(0)
  deposit               Float?        @default(0)
  fromBudget            Boolean?      @default(false)
  budgetId              String?
  concept               String?
  edited                Boolean?      @default(false)
  priceListId           Int?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  customer              Customer?     @relation(fields: [customerId], references: [id])
  items                 SaleItem[]
  payments              Payment[]
  installments          Installment[]
  creditAlerts          CreditAlert[]
  editHistory           SaleEditHistory[]

  @@index([date])
  @@index([customerId])
  @@index([credit])
}

model SaleItem {
  id            Int      @id @default(autoincrement())
  saleId        Int
  productId     Int
  productName   String
  quantity      Float
  unit          Unit
  price         Float
  size          String?
  color         String?
  discount      Float?   @default(0)
  surcharge     Float?   @default(0)
  basePrice     Float?
  notes         String?
  description   String?
  rubro         Rubro?
  fromBudget    Boolean? @default(false)
  budgetId      String?
  costPrice     Float?
  profit        Float?
  profitPercentage Float?

  sale          Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product       Product  @relation(fields: [productId], references: [id])

  @@index([saleId])
  @@index([productId])
}

model SaleEditHistory {
  id            Int      @id @default(autoincrement())
  saleId        Int
  date          DateTime @default(now())
  changes       Json
  previousTotal Float
  newTotal      Float
  sale          Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
}

model Payment {
  id              Int          @id @default(autoincrement())
  saleId          Int
  amount          Float
  date            DateTime     @default(now())
  method          PaymentMethod
  checkNumber     String?
  checkDate       String?
  checkBank       String?
  checkStatus     CheckStatus?
  checkDescription String?
  customerId      String?
  customerName    String?
  installmentNumber Int?
  saleTotal       Float?

  sale            Sale         @relation(fields: [saleId], references: [id], onDelete: Cascade)
  customer        Customer?    @relation(fields: [customerId], references: [id])

  @@index([saleId])
  @@index([customerId])
  @@index([date])
  @@index([checkStatus])
}

model Installment {
  id              Int              @id @default(autoincrement())
  creditSaleId    Int
  number          Int
  dueDate         DateTime
  amount          Float
  interestAmount  Float            @default(0)
  penaltyAmount   Float            @default(0)
  status          InstallmentStatus @default(pendiente)
  paymentDate     DateTime?
  paymentMethod   PaymentMethod?
  daysOverdue     Int?
  totalAmount     Float?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  sale            Sale             @relation(fields: [creditSaleId], references: [id], onDelete: Cascade)
  creditAlerts    CreditAlert[]    @relation("CreditAlertInstallment")

  @@index([creditSaleId])
  @@index([status])
  @@index([dueDate])
}

model CreditAlert {
  id              Int      @id @default(autoincrement())
  creditSaleId    Int
  installmentId   Int?
  type            String // "vencimiento" | "atraso" | "pago"
  status          String   @default("pendiente") // "pendiente" | "resuelta"
  dueDate         DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  sale            Sale     @relation(fields: [creditSaleId], references: [id], onDelete: Cascade)
  installment     Installment? @relation("CreditAlertInstallment", fields: [installmentId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([type])
  @@index([dueDate])
}

model DailyCash {
  id                Int      @id @default(autoincrement())
  date              DateTime @unique @db.Date
  closed            Boolean  @default(false)
  closingAmount     Float?
  closingDate       DateTime?
  closingDifference Float?
  cashIncome        Float?   @default(0)
  cashExpense       Float?   @default(0)
  otherIncome       Float?   @default(0)
  totalIncome       Float?   @default(0)
  totalCashIncome   Float?   @default(0)
  totalExpense      Float?   @default(0)
  totalProfit       Float?   @default(0)
  comments          String?
  openedBy          String?
  closedBy          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  movements        DailyCashMovement[]

  @@index([date])
  @@index([closed])
}

model DailyCashMovement {
  id                    Int           @id @default(autoincrement())
  dailyCashId           Int?
  isDeposit             Boolean?      @default(false)
  originalAmount        Float?
  isBudgetGroup         Boolean?      @default(false)
  method                PaymentMethod?
  amount                Float
  manualAmount          Float?
  discount              Float?        @default(0)
  manualProfitPercentage Float?
  description           String
  type                  MovementType
  date                  DateTime      @default(now()) @db.Date
  paymentMethod         PaymentMethod?
  productId             Int?
  productName           String?
  costPrice             Float?
  sellPrice             Float?
  quantity              Float?
  profit                Float?
  rubro                 Rubro?
  unit                  Unit?
  isCreditPayment       Boolean?      @default(false)
  originalSaleId        Int?
  supplierId            Int?
  supplierName          String?
  size                  String?
  color                 String?
  manualProfit          Float?
  productsProfit        Float?
  profitPercentage      Float?
  budgetId              String?
  fromBudget            Boolean?      @default(false)
  expenseCategory       String?
  customerName          String?
  customerId            String?
  createdAt             DateTime      @default(now())
  timestamp             DateTime?

  dailyCash             DailyCash?    @relation(fields: [dailyCashId], references: [id], onDelete: Cascade)

  @@index([dailyCashId])
  @@index([date])
  @@index([type])
  @@index([paymentMethod])
}

model Budget {
  id              String      @id @default(uuid())
  date            DateTime    @default(now())
  name            String?
  customerName    String
  customerPhone   String?
  customerId      String?
  total           Float
  deposit         String?
  remaining       Float
  expirationDate  DateTime?
  notes           String?
  status          BudgetStatus @default(pendiente)
  rubro           Rubro?
  convertedToSale Boolean?    @default(false)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  customer       Customer?    @relation(fields: [customerId], references: [id])
  items          BudgetItem[]
  budgetNotes    Note[]       @relation("BudgetNotes")

  @@index([customerId])
  @@index([status])
  @@index([createdAt])
}

model BudgetItem {
  id            Int      @id @default(autoincrement())
  budgetId      String
  productId     Int?
  productName   String
  quantity      Float
  unit          Unit
  price         Float
  size          String?
  color         String?
  discount      Float?   @default(0)
  surcharge     Float?   @default(0)
  basePrice     Float?
  notes         String?
  description   String?
  rubro         Rubro?
  costPrice     Float?
  profit        Float?
  profitPercentage Float?

  budget        Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@index([budgetId])
}

model Note {
  id        Int       @id @default(autoincrement())
  customerId String?
  budgetId   String?
  content    String
  createdBy  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer  Customer? @relation("CustomerNotes", fields: [customerId], references: [id], onDelete: Cascade)
  budget    Budget?  @relation("BudgetNotes", fields: [budgetId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([budgetId])
}

model CustomCategory {
  id    Int   @id @default(autoincrement())
  name  String
  rubro Rubro

  @@unique([name, rubro])
  @@index([rubro])
}

model ProductReturn {
  id          Int      @id @default(autoincrement())
  productId   Int
  productName String
  reason      String
  date        DateTime @default(now()) @db.Date
  stockAdded  Float
  amount      Float
  profit      Float
  rubro       Rubro

  product     Product  @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([date])
}

model ExpenseCategory {
  id    Int         @id @default(autoincrement())
  name  String
  rubro Rubro
  type  ExpenseType @default(EGRESO)

  @@index([rubro])
  @@index([type])
}

model Expense {
  id                    Int           @id @default(autoincrement())
  amount                Float
  date                  DateTime      @default(now()) @db.Date
  description           String
  category              String
  paymentMethod         PaymentMethod
  receipt               String?
  installments          Int?
  rubro                 Rubro
  supplier              String?
  type                  ExpenseType   @default(EGRESO)
  combinedPaymentMethods Json? // Array of PaymentSplit

  @@index([date])
  @@index([category])
  @@index([type])
}

model Promotion {
  id                Int             @id @default(autoincrement())
  name              String
  description       String
  type              PromotionType
  status            PromotionStatus @default(active)
  discount          Float
  rubro             String
  startDate         DateTime        @default(now())
  endDate           DateTime?
  minPurchaseAmount Float?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([rubro])
  @@index([status])
  @@index([startDate])
}

model Notification {
  id              Int             @id @default(autoincrement())
  title           String
  message         String
  date            DateTime        @default(now())
  read            Boolean         @default(false)
  type            NotificationType?
  link            String?
  version         String?
  actualizationId Int?
  isDeleted       Boolean         @default(false)

  @@index([read])
  @@index([date])
  @@index([isDeleted])
}

model DeletedActualization {
  id             Int @id @default(autoincrement())
  actualizationId Int

  @@index([actualizationId])
}

model UserPreferences {
  id                  Int      @id @default(autoincrement())
  userId              Int?     @unique
  acceptedTerms       Boolean  @default(false)
  acceptedTermsDate   DateTime?
  itemsPerPage        Int?
  appVersion          String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user                User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model BusinessData {
  id      Int    @id @default(autoincrement())
  name    String
  address String
  phone   String
  cuit    String
}

model AppState {
  id            Int      @id @default(autoincrement())
  lastActiveDate DateTime @default(now())
}

model TrialPeriod {
  id              Int      @id @default(autoincrement())
  userId          Int      @unique
  firstAccessDate DateTime @default(now())

  @@index([userId])
}
